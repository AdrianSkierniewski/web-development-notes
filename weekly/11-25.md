Tuesday, 26 November 2013
===============================
I'm having a problem mocking Auth. Particularly, I'm trying to mock a failed login. I'm trying:

    Auth::shouldReceive('attempt')->andReturn(False);

... but that doesn't work. I'm getting an error: 

    PDOException: SQLSTATE[HY000]: General error: 1 no such table: users

I haven't created a users table, yet. Theoretically, by using a mock, I shouldn't have to. It shouldn't be touching the database. But it's not working... :-(

It did work as soon as I created a user table, though, even though I didn't put anything in the user table. 

Next thing: In the live version, I can see the phrase 'There were errors' when the user enters invalid credentials. In the codeception functional test, it doesn't do that. It's just the standard page. What do I have to do to get codeception to redirect with the correct information?

Hmmmm... It looks like it's not picking up the session data... The default session driver was set to array, so that might affect it. I changed it to 'native', though, and it's still doing it.

In my controller, if I use var_dump to show the contents of \Session::all(), it doesn't show it at all in the codeception debug page. 

Actually, it won't var_dump anything... In the test, those might be going to the console, rather than the html file. We don't see anything sent to the console, because it's rewriting things on the fly...

This works, to write things to the Laravel log file:

```php
    public function getLogin()
    {
        \Log::info(var_export(\Session::all(),true));
        $this->layout->content = View::make('days.004.login')
            ->with('username','');
    }
```

In the standard unit test, it doesn't show the redirect. It wouldn't, because we have $this->client->followRedirects = false, by default. We can see that it has a redirect, though.

In the codeception test, it looks like it has the data it needs. For some reason, in the view, it's not translating the data correctly. 

So, Session::get('errors') works, but $errors does not. It looks like $errors is an empty variable. How are the local variables created in Laravel?

In login.blade.php, above the @section('content') line, I can define $errors. It really does work, but it's not pretty. There is something about the codeception tests that don't run... something. Something gets skipped, and the test doesn't work.

I don't really understand it, but I have a workaround.



### Column Names
I just found an interesting way to get column/field names from the table used by an Eloquent model. This is from http://laravelsnippets.com/snippets/get-all-columns-names-from-a-eloquent-model-2:

class BaseModel extends \Eloquent 
{
    public function getColumnsNames()
    {
        $connection = DB::connection();
        $connection->getSchemaBuilder();
         
        $grammar = $connection->getSchemaGrammar();
        $table = $connection->getTablePrefix().$this->table;
        $results = $connection->select($grammar->compileColumnExists($table));
        return array_unique($connection->getPostProcessor()
            ->processColumnListing($results));
    }
}
- See more at: http://laravelsnippets.com/snippets/get-all-columns-names-from-a-eloquent-model-2#sthash.cimnbXdn.dpuf

### Bowling-Game Kata
https://github.com/pixelhandler/vagrant-dev-env/tree/bowling/www



Wednesday, 27 November 2013
===============================
This morning, let's see if I can play with OAuth for logins....

First thing, which OAuth library to use? There are several. 

The recommended library is madewithlove/laravel-oauth2
It has some usage, no unit tests. 243 installs from packagist; 2 users have updated 5 things in the past month.

Also thomaswelton/laravel-oauth
794 installs from packagist; few updates; no unit tests. Says not to use for production on the front page. :-)  It's a laravel wrapper around lusitanian/oauth. It has several migrations to hold oauth logins. Lots of contributions to open source projects. Lacking docs, really... Lots of code...

Also artdarek/oauth-4-laravel
1238 installs from packagist; no unit tests; not many updates. Simple laravel wrapper around lusitanian/oauth. Maintainer doesn't have many contributions to open source projects (and less more recently). Excellent documentation. Very simple wrapper; not much code at all. a

Lusitanian/oauth is an active library with lots of contributors. 10 authors with 59 commits over the past month; unit tested. 5504 installs this month. It definitely looks to be something I want. 

Let's try the thomaswelton version. 

After installing, it creates some new routes for my project:

    DELETE /oauth/{provider}
    GET /oauth/{provider}/login 
    GET /oauth/{provider}/authorize 
    GET /oauth/{provider}

Immediately, my routes test fails. The login route isn't callable. The controller only has index, authorize, and destroy methods. In order to play with this, I'll have to fix it. No idea how to do that, right now. And I'm already over an hour into this...

Let's play with the artdarek version...

It doesn't really do anything itself, so is easy to install...

    php artisan config:publish artdarek/oauth-4-laravel

This gives me a file:

    app/config/packages/artdarek/oauth-4-laravel/config.php

It seems to me that I'm going to want to put that in .gitignore, so it doesn't end up in the public repository on github, and copy the data manually...

And now, I need to figure out how to get some credentials...


#### Google

    https://code.google.com/apis/console
    Google+ API
    Name: Daily Practice -- Day 5

    Consent Screen:
        Product Name: Daily Practice
        Homepage URL: http://daily.kumuwai.com

    Registered Apps:
        Name: Daily Practice -- Day 5
        Type: Web Application


How can we test this? Is there anything we can test locally? Does it have to be on the server before I can test it? 

Need more information... Are there any howtos?

Ahhh... Now I find this:

http://www.mrcasual.com/on/coding/laravel4-package-management-with-composer/

It's still not an end-to-end howto, though. How do I put a link on my page? 

    <a href="https://accounts.google.com/o/oauth2/auth?state=%2Fprofile&amp;redirect_uri=http://localhost:80/daily.dev/day005_login&amp;response_type=code&amp;client_id=329408182449.apps.googleusercontent.com&amp;approval_prompt=force&amp;scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.profile">Login via Google</a></p>

One problem, though: Google supports redirecting to localhost, and it supports redirecting to a known page, but it does not support redirecting to my own named instances, on my own machine. (eg, daily.dev/day005_login). Somehow, I need to get a request sent to localhost to redirect to a dev address...

We will get things that look like this:
http://daily.kumuwai.com/day005_login_google?state=/profile&code=4/TTAKJ7vFDM_0EMlTMB6LWM0g7nm2.gnI_IuCwOswfMqTmHjyTFGNiPN01hQI

Hmmmm.... It kind of works, but not really. I don't know how to test it, except on the server. I'm doing that, but getting an error:

[2013-11-27 18:57:43] log.ERROR: exception 'OAuth\Common\Http\Exception\TokenResponseException' with message 'Failed to request resource.' in daily.kumuwai.com/vendor/lusitanian/oauth/src/OAuth/Common/Http/Client/StreamClient.php:62

I just discovered that I can do things on my client! And, it's easy. In /etc/apache2/sites-available/000-default.conf:

    RedirectMatch ^/daily.dev/(.*) http://daily.dev/$1

This redirects it internally. Yay!

...but I'm still confused enough that I don't think I'm going to get this working today. I get a state and a code, but what can I do with it??????

Is there any way to set a callback url for my google service? If so, I can at least check some things... I tried putting it directly in OAuth/Common/Consumer/Credentials.php, but it didn't take it...

It looks like the credentials are passed in to OAuth/Common/Service/AbstractService, and are already set at that point.

There's a ServiceFactory, but credentials are already set by the time it gets there...

How are the credentials created? Can they be changed? Will that help me at all?

Tomorrow, maybe something simple?


Thursday, 28 November 2013
===============================

Hmmmmmm.... I'm not sure where they get created to start with, but I just found out that I get good data if I set them manually in the Credentials.php constructor.

Throw an exception in the constructor...

That's a great way to find out what calls something...

It's called in OAuth.php, function 'consumer'. It takes an optional url and scope.

I can set the scope in my configuration file, and read that at runtime. Just remember that Config::get is case-sensitive....

Strange... at this point, I'm getting a positive response whether I click "OK" or "Cancel". It's like Google is remembering I said "yes", at one point, and not letting me say "no" now.

I really don't like that. Any way around it?

